@using LMS.Web.Infrastructure;
@{
    UserProfile profile = Session["UserInfo"] as UserProfile;
    if (profile == null)
    {
        profile = new UserProfile
        {
            ClientName = "LMS",
            FirstName = "Guest",
            LastName = "User",
            UserId = -1
        };
    }

    ViewBag.Title = "Welcome " + profile.FirstName + " " + profile.LastName + ",";

    if (Layout.Contains("_Layout.super.admin.cshtml"))
    {
        @Html.Partial("_SuperAdmin")
    }
    if (Layout.Contains("_Layout.admin.cshtml"))
    {
        @Html.Partial("_Admin")
    }
    if (Layout.Contains("_Layout.user.cshtml"))
    {
        @Html.Partial("_User")
    }
}
@section head {
    <link href="http://cdn.kendostatic.com/2014.2.903/styles/kendo.common.min.css" rel="stylesheet" />
    <link href="~/Content/kendo-styles/kendo.silver.min.css" rel="stylesheet" />
    <link href="http://cdn.kendostatic.com/2014.2.903/styles/kendo.dataviz.min.css" rel="stylesheet" />
    <link href="http://cdn.kendostatic.com/2014.2.903/styles/kendo.dataviz.default.min.css" rel="stylesheet" />
}
@section scripts {
    <script type="text/javascript">
        var USER_ID = @profile.UserId;
        (function() {
            // fix angular binding error, only needs one ng controller
            var app = angular.module("LMS", []);
            var SuperAdminDashboard = function($scope) {}
            var AdminDashboard = function($scope) {}
            app.controller("SuperAdminDashboard", ["$scope", SuperAdminDashboard]);
            app.controller("AdminDashboard", ["$scope", AdminDashboard]);
        }());
    </script>
    <script type="text/javascript" src="http://cdn.kendostatic.com/2014.2.903/js/kendo.all.min.js"></script>  
    <script src="~/Scripts/Library/kendo-js/kendo.angular.min.js"></script>
    <script type="text/javascript">
        (function() {
            var app = angular.module("LMS", ["kendo.directives"]);
            var UserDashboardController = function($scope, $http) {

                userDashboardScope = $scope;
                userDashboardScope.httpService = $http;
                userDashboardScope.CoursesList = [];
                userDashboardScope.calendarDates = [];
                //{ Confirm: false, CourseName: "", CourseDescription: "", CourseContentResource: "", CourseContentName: "", CourseSessionId: "", CourseSessionStartDate: null, CourseSessionEndDate: null, CourseSessionStartDateString: "", CourseSessionEndDateString: ""}
                userDashboardScope.loadData = function() {
                    userDashboardScope.httpService({
                            method: "GET",
                            url: API_URL + "/Courses/GetCoursesByUser/" + USER_ID,
                            headers: {
                                "Authorization": "Bearer " + TOKEN
                            }
                        })
                        .success(function(data) {
                            userDashboardScope.CoursesList.length = 0;
                            userDashboardScope.calendarDates.length = 0;
                            userDashboardScope.CoursesList = JSON.parse(data);

                            // populate CourseSessionStartDateString and CourseSessionEndDateString
                            $.each(userDashboardScope.CoursesList, function(i, value) {
                                userDashboardScope.CoursesList[i].CourseSessionStartDateString = userDashboardScope.getDateStringFromJSONString(value.CourseSessionStartDate);
                                userDashboardScope.CoursesList[i].CourseSessionEndDateString = userDashboardScope.getDateStringFromJSONString(value.CourseSessionEndDate);
                                userDashboardScope.CoursesList[i].SubmittedWithoutCheck = false;
                                if(!value.LearningComplete) {
                                    userDashboardScope.calculateTimeRemaining(userDashboardScope.CoursesList[i]);
                                }                                
                            });
                        })
                        .error(function(data, status) {
                            userDashboardScope.showUserFailure(data);
                        });
                };

                userDashboardScope.calendarConfig = {
                    value: new Date(), // today
                    dates: userDashboardScope.calendarDates,
                    month: {
                        // template for dates in month view
                        content: '# if ($.inArray(data.date.getTime(), userDashboardScope.calendarDates) != -1) { #' +
                            '<div class="highlight-day">#= data.value #</div>' +
                            '# } else { #' +
                            '#= data.value #' +
                            '# } #'
                    },
                    footer: '<div class="highlight-day-cell highlight-day-legend">&nbsp;</div> Completed by dates'//false
                }

                userDashboardScope.calculateTimeRemaining = function(course) {
                    var startDate = userDashboardScope.getDateObjectFromJSONString(course.CourseSessionStartDate);
                    var endDate = userDashboardScope.getDateObjectFromJSONString(course.CourseSessionEndDate);
                    //endDate.setDate(endDate.getDate() + 2);
                    var today = new Date();

                    if (today >= endDate) {
                        course.PercentToFill = 100;
                        course.DaysRemaining = 0;
                        course.DaysRemainingString = "0 days remaining";
                    } else {
                        var totalMilliseconds = Math.ceil(endDate - startDate);
                        var totalDays = totalMilliseconds / (1000 * 60 * 60 * 24);
                        var timeRemainingMilliseconds = Math.ceil(endDate - today);
                        var timeRemainingDays = Math.ceil(timeRemainingMilliseconds / (1000 * 60 * 60 * 24));
                        var timeRemainingPercent = Math.ceil(timeRemainingDays / totalDays * 100);

                        course.PercentToFill = 99 - timeRemainingPercent; // we really want 100 - x. But 1% progress looks better on the UI
                        course.DaysRemaining = timeRemainingDays;
                        course.DaysRemainingString = timeRemainingDays === 1 ? "1 day remaining" : timeRemainingDays + " days remaining";
                        //console.log("start date = " + startDate);
                        //console.log("end date = " + endDate);
                        //console.log("total days = " + totalDays);
                        //console.log("remaining = " + timeRemainingDays);
                        //console.log("perc = " + timeRemainingPercent);
                    }

                    // push the end date to the calendar (push as getTime integer for $.inArray comparison)
                    userDashboardScope.calendarDates.push(endDate.getTime());
                        
                    // reinitialise calendar and highlight events
                    userDashboardScope.updateCalendar();
                }

                userDashboardScope.checkUserInput = function(course) {
                    course.SubmittedWithoutCheck = !course.LearningComplete;
                }

                userDashboardScope.updateCalendar = function() {                   
                    $("#calendar").data('kendoCalendar').navigateToPast();
                    $("#calendar").data('kendoCalendar').navigateToFuture();
                    $(".highlight-day").parent().parent().addClass("highlight-day-cell");
                }

                userDashboardScope.submit = function(course) {
                    if (!course.LearningComplete) {
                        course.SubmittedWithoutCheck = true;
                    } else {
                        course.SubmittedWithoutCheck = false;
                        userDashboardScope.httpService({
                            method: "PATCH",
                            url: API_URL + "/UsersInCourseSessions/UpdateUserResultInCourseSession/" + course.CourseSessionId,
                            data: {
                                CourseSessionId: course.CourseSessionId,
                                UserId: USER_ID,
                                LearningComplete: course.LearningComplete
                            },
                            headers: {
                                "Authorization": "Bearer " + TOKEN
                            }
                        })
                        .success(function(data) {
                            userDashboardScope.showCourseUpdate(course);
                            userDashboardScope.loadData();
                            // reinitialise calendar and highlight events
                            userDashboardScope.updateCalendar();
                        })
                        .error(function(data, status) {
                            userDashboardScope.showUserFailure(data);
                        });
                    }
                }

                userDashboardScope.getDateStringFromJSONString = function(JSONString) {
                    var dateString = JSONString.match(/[0-9]+/g)[0];
                    var formattedDate = new Date(parseInt(dateString, 10));
                    var d = formattedDate.getDate().toString();
                    var m = formattedDate.getMonth().toString();
                    m += 1; // JavaScript months are 0-11
                    var y = formattedDate.getFullYear();

                    // prepend single day/month with zero
                    d = ('0' + d).slice(-2);
                    m = ('0' + m).slice(-2);

                    return d + "/" + m + "/" + y;
                }

                userDashboardScope.getDateObjectFromJSONString = function(JSONString) {
                    var dateString = JSONString.match(/[0-9]+/g)[0];
                    return new Date(parseInt(dateString, 10));
                }

                userDashboardScope.showCourseUpdate = function(course) {
                    var msg = "Congratulations, course: <b>" + course.CourseName + "</b> successfully completed!";

                    $(".alert-success .msg")
                        .html(msg)
                        .parent()
                        .removeClass("hidden")
                        .slideDown();
                }

                userDashboardScope.showUserFailure = function(data) {
                    $(".alert-danger .msg")
                        .html(data.ExceptionMessage)
                        .parent()
                        .removeClass("hidden")
                        .slideDown();
                }

                // initialize data
                userDashboardScope.loadData();
            }
            app.controller("UserDashboardController", ["$scope", "$http", UserDashboardController]);
        }());
    </script>
}